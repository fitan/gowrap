{{/* gotype: github.com/fitan/gowrap/generator.TemplateInputs */}}
import (
"encoding/json"
"net/http"
"strings"

valid "github.com/asaskevich/govalidator"
"github.com/go-kit/kit/endpoint"
kithttp "github.com/go-kit/kit/transport/http"
"github.com/gorilla/mux"
"github.com/pkg/errors"
"github.com/spf13/cast"

{{range $i := $.Imports}}
    {{$i}}
{{end}}
)

func MakeHTTPHandler(s Service, dmw []endpoint.Middleware, opts []kithttp.ServerOption) http.Handler {
	var ems []endpoint.Middleware

	opts = append(opts, kithttp.ServerBefore(func(ctx context.Context, request *http.Request) context.Context {
		return ctx
	}))

	ems = append(ems, dmw...)

	eps := NewEndpoint(s, map[string][]endpoint.Middleware{
		{{range $m := $.Interface.Methods}}
		"{{$m.Name}}": ems,
		{{end}}
	})

	r := mux.NewRouter()

	{{range $m := $.Interface.Methods}}
	r.Handle("{{$m.KitConf.Conf.Url}}", kithttp.NewServer(
		eps.{{$m.Name}}Endpoint,
		decode{{$m.Name}}Request,
		kithttp.EncodeJSONResponse,
		opts...,
	)).Methods("{{up $m.KitConf.Conf.UrlMethod}}")
	{{end}}

	return r
}

{{range $m := $.Interface.Methods}}
{{$m.KitRequestDecode}}
{{end}}
